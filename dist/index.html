<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>GigByCity | Ultra UI</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;700&family=Libre+Barcode+128+Text&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <link rel="stylesheet" href="style.css">

    <script defer src="script.js"></script>
</head>
<body>

  <div id="splashScreen">
    <div class="splash-logo">GigByCity</div>
    <div class="splash-loader"></div>
  </div>

  <div id="onboardingModal">
      <div class="onboarding-slide active" data-step="0">
          <img src="https://images.unsplash.com/photo-1493225255756-d9584f8606e9?q=80&w=2070&auto=format&fit=crop" class="ob-img">
          <div class="ob-title">Discover the Underground</div>
          <div class="ob-desc">Find exclusive parties, street races, and car meets happening in your sector. The grid is waiting.</div>
      </div>
      <div class="onboarding-slide" data-step="1">
          <img src="https://images.unsplash.com/photo-1550989460-0adf9ea622e2?q=80&w=1974&auto=format&fit=crop" class="ob-img">
          <div class="ob-title">Your Digital Access</div>
          <div class="ob-desc">No papers, no hassle. Your unique QR pass is your ticket. Secure your spot instantly.</div>
      </div>
      <div class="onboarding-slide" data-step="2">
          <img src="https://images.unsplash.com/photo-1533174072545-e8d4aa97edf9?q=80&w=1974&auto=format&fit=crop" class="ob-img">
          <div class="ob-title">Control the Night</div>
          <div class="ob-desc">Host your own drops. Manage guest lists, scan tickets, and build your reputation.</div>
      </div>

      <div class="ob-dots">
          <div class="ob-dot active" id="obDot0"></div>
          <div class="ob-dot" id="obDot1"></div>
          <div class="ob-dot" id="obDot2"></div>
      </div>

      <button class="btn-main" style="width: 80%; max-width: 300px;" onclick="nextOnboarding()">NEXT</button>
      <button style="margin-top: 16px; background: none; border: none; font-weight: 700; color: var(--text-muted); cursor: pointer;" onclick="closeOnboarding()">SKIP</button>
  </div>

  <div id="authScreen" class="auth-wrap hide">
    <div class="auth-bg">
        <img src="https://images.unsplash.com/photo-1497366216548-37526070297c?q=80&w=2069&auto=format&fit=crop" alt="Abstract Office">
        <div class="auth-overlay"></div>
    </div>
    <div class="auth-card">
        <div class="auth-header">
            <div class="auth-logo">FIDA</div>
            <p id="authSubtitle" style="color:var(--text-sec); font-size:1.1rem; font-weight:500;">Access the grid.</p>
        </div>
        
        <div style="margin-top: 30px; margin-bottom: 20px;">
            <div id="googleBtnContainer"></div>
        </div>

        <p style="text-align:center; font-size:0.8rem; color:var(--text-muted); line-height:1.5;">
            By entering the system, you agree to the<br>Protocol Standards & Data Policy.
        </p>
    </div>
  </div>

  <header class="app-header">
    <a href="#" class="brand">
      <div class="brand-mark"></div>
      FIDA
    </a>
    <div class="user-pill" onclick="switchView('settings', document.querySelector('.dock-item:last-child'))">
        <span id="headerName">GUEST</span>
        <div class="avatar-circle" id="headerAvatar">G</div>
    </div>
  </header>

  <div id="viewHome" class="view-section active">
    
    <section class="hero">
        <div class="hero-carousel">
            <div class="carousel-track" id="heroTrack">
                <div class="hero-slide active">
                    <img src="https://i.pinimg.com/736x/ac/fa/07/acfa075232e1fa71a0546c9112b6f877.jpg" class="hero-bg" alt="Event">
                    <div class="hero-overlay"></div>
                    <div class="hero-content">
                        <div class="live-badge"><div class="pulse-dot"></div> LIVE NOW</div>
                        <h2 class="hero-title">HOUSE<br>PARTY'S</h2>
                        <p class="hero-desc">Party Like Never Before.</p>
                    </div>
                </div>
                 <div class="hero-slide">
                    <img src="https://www.nme.com/wp-content/uploads/2021/10/The-Beatles_-Get-Back.jpg" class="hero-bg" alt="Jazz">
                    <div class="hero-overlay"></div>
                    <div class="hero-content">
                        <div class="live-badge" style="border-color:rgba(100,100,255,0.4); color:#aaaaff; background:rgba(50,50,200,0.2);">UP NEXT</div>
                        <h2 class="hero-title">THE<br>BEATLES</h2>
                        <p class="hero-desc">Relive the beatles era.</p>
                    </div>
                </div>
            </div>
            
            <div class="carousel-dots">
                <div class="dot active"></div>
                <div class="dot"></div>
            </div>
        </div>
    </section>

    <div class="search-wrap">
        <div class="search-bar">
            <svg class="icon icon-sm" viewBox="0 0 24 24" style="color:var(--text-muted)"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            <input type="text" id="searchInput" class="search-input" placeholder="Search events..." onkeyup="handleSearch(this.value)">
        </div>
        <div class="filter-btn" onclick="openFilterModal()">
             <svg class="icon" viewBox="0 0 24 24"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
        </div>
    </div>

    <div id="clubsContainer" class="feed" style="margin-top:10px;"></div>
    
  </div>

  <div id="viewPasses" class="view-section">
      <div style="padding: 20px; font-size:1.8rem; font-weight:800; letter-spacing:-0.03em;">My Passes</div>
      <div id="passesContainer" class="feed" style="padding: 0 20px 40px;"></div>
  </div>

  <div id="viewHost" class="view-section">
      <div style="display:flex; justify-content:space-between; align-items:center; padding:20px;">
          <div style="font-size:1.8rem; font-weight:800; letter-spacing:-0.03em;">Host Dashboard</div>
          <button onclick="startScanner()" style="background:var(--text-main); color:white; border:none; width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer;">
              <svg class="icon" viewBox="0 0 24 24"><path d="M3 7V5a2 2 0 0 1 2-2h2"></path><path d="M17 3h2a2 2 0 0 1 2 2v2"></path><path d="M21 17v2a2 2 0 0 1-2 2h-2"></path><path d="M7 21H5a2 2 0 0 1-2-2v-2"></path></svg>
          </button>
      </div>
      <div id="hostContainer" class="feed"></div>
  </div>

  <div id="viewSettings" class="view-section">
      <div style="padding: 20px; font-size:1.8rem; font-weight:800; letter-spacing:-0.03em;">Profile & Settings</div>
      <div style="padding: 0 20px;">
          
          <div style="text-align: center; margin-bottom: 24px;">
              <div style="width: 100px; height: 100px; background: var(--bg-dots); border-radius: 50%; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: 700; overflow:hidden; border:2px solid var(--border);" id="settingsAvatarDisplay"></div>
              <label style="background: var(--bg-card-sub); border: 1px solid var(--border); padding: 8px 16px; border-radius: 100px; font-size: 0.8rem; font-weight: 700; cursor: pointer; color: var(--text-sec);">
                  Change Photo <input type="file" hidden accept="image/*" onchange="handleAvatarUpload(this)">
              </label>
          </div>

          <form onsubmit="saveProfile(event)" style="background: white; padding: 24px; border-radius: 24px; border: 1px solid var(--border); box-shadow: var(--shadow-sm); margin-bottom: 24px;">
              
              <div class="form-section" style="margin-bottom: 20px;">
                  <label class="form-label">Contact Info</label>
                  <div class="inp-group-icon" style="margin-bottom: 12px;">
                      <svg class="icon-sm" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                      <input type="text" id="pName" class="inp-plain" placeholder="Full Name" required>
                  </div>
                  <div class="inp-group-icon" style="margin-bottom: 12px;">
                      <svg class="icon-sm" viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                      <input type="email" id="pEmail" class="inp-plain" placeholder="Email Address" required disabled style="opacity: 0.6;">
                  </div>
                  <div class="inp-group-icon" style="margin-bottom: 12px;">
                      <svg class="icon-sm" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                      <input type="tel" id="pPhone" class="inp-plain" placeholder="Phone Number">
                  </div>
                  <div class="inp-group-icon">
                      <svg class="icon-sm" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                      <input type="text" id="pCity" class="inp-plain" placeholder="City / Sector">
                  </div>
              </div>

              <button type="submit" class="btn-main" style="height: 56px;">SAVE CHANGES</button>
          </form>

          <div style="background: white; border-radius: 24px; overflow: hidden; border: 1px solid var(--border); margin-bottom:40px;">
              
              <div style="padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                  <div style="display:flex; align-items:center; gap:12px;">
                      <div style="width:32px; height:32px; background:var(--bg-card-sub); border-radius:8px; display:flex; align-items:center; justify-content:center;">
                          <svg class="icon-sm" viewBox="0 0 24 24"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12.01" y2="18"></line></svg>
                      </div>
                      <span style="font-weight:600;">App Version</span>
                  </div>
                  <span style="color: var(--text-muted); font-family: var(--font-mono);">v2.8.0</span>
              </div>

              <div onclick="openInfoSheet('about')" style="padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                  <div style="display:flex; align-items:center; gap:12px;">
                      <div style="width:32px; height:32px; background:var(--bg-card-sub); border-radius:8px; display:flex; align-items:center; justify-content:center;">
                          <svg class="icon-sm" viewBox="0 0 24 24"><path d="M3 21h18"></path><path d="M5 21V7l8-4 8 4v14"></path><path d="M17 21v-8.5a1.5 1.5 0 0 0-1.5-1.5h-5a1.5 1.5 0 0 0-1.5 1.5V21"></path></svg>
                      </div>
                      <span style="font-weight:600;">About Company</span>
                  </div>
                  <svg class="icon-sm" style="color:var(--text-muted);" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg>
              </div>

              <div onclick="openInfoSheet('privacy')" style="padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                  <div style="display:flex; align-items:center; gap:12px;">
                      <div style="width:32px; height:32px; background:var(--bg-card-sub); border-radius:8px; display:flex; align-items:center; justify-content:center;">
                          <svg class="icon-sm" viewBox="0 0 24 24"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                      </div>
                      <span style="font-weight:600;">Privacy & Security</span>
                  </div>
                  <svg class="icon-sm" style="color:var(--text-muted);" viewBox="0 0 24 24"><polyline points="9 18 15 12 9 6"></polyline></svg>
              </div>

              <div onclick="logout()" style="padding: 16px 20px; color: #ef4444; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: space-between;">
                  <div style="display:flex; align-items:center; gap:12px;">
                      <div style="width:32px; height:32px; background:rgba(239, 68, 68, 0.1); border-radius:8px; display:flex; align-items:center; justify-content:center;">
                          <svg class="icon-sm" style="color:#ef4444;" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                      </div>
                      <span>Log Out</span>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <div class="dock-container">
    <div class="dock">
        <div class="dock-item active" onclick="switchView('home', this)">
            <svg class="icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
        </div>
        <div class="dock-item" onclick="switchView('passes', this)">
            <svg class="icon" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
        </div>
        <div class="dock-fab" onclick="openCreateModal()">
            <svg class="icon" viewBox="0 0 24 24" style="stroke:white;"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        </div>
        <div class="dock-item" onclick="switchView('host', this)">
            <svg class="icon" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
        </div>
        <div class="dock-item" onclick="switchView('settings', this)">
            <svg class="icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
        </div>
    </div>
  </div>

  <div id="detailsModal" class="overlay">
    <div class="sheet">
        <div class="sheet-handle"></div>
        <div class="sheet-header-sticky">
             <div style="display:flex; align-items:center;">
                 <button onclick="document.getElementById('detailsModal').classList.remove('visible')" style="background:transparent; border:1px solid var(--border); width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; color:var(--text-main); margin-right:12px;">
                    <svg class="icon" viewBox="0 0 24 24"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                 </button>
                 <span style="font-weight:700; font-size:0.9rem; color:var(--text-sec);">BACK</span>
            </div>
        </div>
        <div class="sheet-body" id="detailsContent"></div>
    </div>
  </div>

  <div id="infoModal" class="overlay">
    <div class="sheet">
        <div class="sheet-handle"></div>
        <div class="sheet-header-sticky">
             <div style="display:flex; align-items:center;">
                 <button onclick="document.getElementById('infoModal').classList.remove('visible')" style="background:transparent; border:1px solid var(--border); width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; color:var(--text-main); margin-right:12px;">
                    <svg class="icon" viewBox="0 0 24 24"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                 </button>
                 <span style="font-weight:700; font-size:0.9rem; color:var(--text-sec);">BACK</span>
            </div>
        </div>
        <div class="sheet-body" id="infoContent" style="padding: 0 28px 48px; line-height: 1.6; color: var(--text-sec);"></div>
    </div>
  </div>

  <div id="hostDetailModal" class="overlay">
    <div class="sheet">
        <div class="sheet-handle"></div>
        <div class="sheet-header-sticky" style="padding-bottom: 10px;">
             <div style="display:flex; align-items:center;">
                 <button onclick="document.getElementById('hostDetailModal').classList.remove('visible')" style="background:transparent; border:1px solid var(--border); width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; color:var(--text-main); margin-right:12px;">
                    <svg class="icon" viewBox="0 0 24 24"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                 </button>
                 <span style="font-weight:700; font-size:0.9rem; color:var(--text-sec);">DASHBOARD</span>
            </div>
        </div>
        <div class="sheet-body" id="hostDetailContent" style="padding-top:0;"></div>
    </div>
  </div>

  <div id="createModal" class="overlay">
    <div class="sheet">
        <div class="sheet-handle" id="createHandle"></div>
        <div class="sheet-header-sticky">
            <div style="display:flex; align-items:center; justify-content:space-between; width:100%;">
                 <div style="display:flex; align-items:center;">
                     <button onclick="closeCreateModal()" style="background:transparent; border:1px solid var(--border); width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; color:var(--text-main); margin-right:12px;">
                        <svg class="icon" viewBox="0 0 24 24"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                     </button>
                     <span style="font-weight:700; font-size:0.9rem; color:var(--text-sec);">CANCEL</span>
                 </div>
                 <span style="font-weight:800; letter-spacing:-0.03em; font-size:1.1rem;">NEW DROP</span>
                 <div style="width:40px;"></div> 
            </div>
        </div>
        <div class="sheet-body">
            <form onsubmit="handleCreate(event)">
                
                <input type="text" id="cName" class="c-title-input" placeholder="Event Title..." required>

                <div class="upload-zone" id="uploadZone">
                    <input type="file" id="cImageInput" accept="image/*" onchange="previewImage(this)">
                    <img id="cImagePreview">
                    <div class="upload-placeholder">
                        <div class="upload-icon">
                            <svg class="icon" viewBox="0 0 24 24" style="stroke: white;"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                        </div>
                        <span style="font-weight:700; color:var(--text-main); font-size: 0.9rem;">Tap to Upload Cover</span>
                        <span style="font-size:0.75rem; color:var(--text-muted); font-weight:600;">16:9 ‚Ä¢ High Quality</span>
                    </div>
                </div>

                <div class="form-section">
                    <label class="form-label">Category</label>
                    <div class="category-scroll">
                        <input type="hidden" id="cCategory" value="PARTY">
                        <div class="chip active" onclick="selectCategory(this, 'PARTY')">üéâ PARTY</div>
                        <div class="chip" onclick="selectCategory(this, 'RACE')">üèéÔ∏è RACE</div>
                        <div class="chip" onclick="selectCategory(this, 'SHOW')">üé® SHOW</div>
                        <div class="chip" onclick="selectCategory(this, 'MEET')">ü§ù MEET</div>
                    </div>
                </div>

                <div class="form-section">
                    <label class="form-label">Description</label>
                    <div class="inp-group-icon" style="height: auto; padding: 16px;">
                        <textarea id="cDesc" class="inp-plain" style="height:80px; resize:none; line-height:1.5; font-weight:500;" placeholder="What's the vibe? Any special instructions?" required></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <label class="form-label">Logistics</label>
                    <div class="segmented-control">
                        <div class="segment-btn active" id="btnOffline" onclick="setEventMode('offline')">IN PERSON</div>
                        <div class="segment-btn" id="btnOnline" onclick="setEventMode('online')">ONLINE</div>
                    </div>
                    <input type="hidden" id="cMode" value="offline">

                    <div class="grid-2" style="margin-bottom: 16px;">
                        <div class="inp-group-icon">
                            <svg class="icon-sm" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                            <input type="date" id="cDate" class="inp-plain" required>
                        </div>
                        <div class="inp-group-icon">
                            <svg class="icon-sm" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
                            <input type="time" id="cTime" class="inp-plain" required>
                        </div>
                    </div>
                    <div class="inp-group-icon">
                        <div id="cLocIcon">
                            <svg class="icon-sm" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                        </div>
                        <input type="text" id="cLoc" class="inp-plain" placeholder="Location or Address" required>
                    </div>
                </div>

                <div class="form-section">
                    <label class="form-label">Access & Capacity</label>
                    <div class="grid-2">
                        <div class="inp-group-icon">
                            <span style="font-weight:700; font-family:var(--font-mono); color:var(--text-muted); font-size: 1.1rem;">$</span>
                            <input type="number" id="cPrice" class="inp-plain" placeholder="Price">
                        </div>
                        <div class="inp-group-icon">
                            <svg class="icon-sm" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                            <input type="number" id="cMax" class="inp-plain" placeholder="Max People">
                        </div>
                    </div>
                </div>

                <div style="height:20px;"></div>
                <button class="btn-main" type="submit" style="box-shadow: 0 10px 30px rgba(0,0,0,0.15);">PUBLISH DROP</button>
            </form>
        </div>
    </div>
  </div>

  <div id="filterModal" class="overlay">
    <div class="sheet">
        <div class="sheet-handle"></div>
        <div class="sheet-header-sticky">
             <div style="display:flex; align-items:center; justify-content:space-between; width:100%;">
                 <span style="font-weight:800; font-size:1.1rem;">FILTER EVENTS</span>
                 <button onclick="closeFilterModal()" style="background:transparent; border:none; font-weight:700; color:var(--text-main); font-size:0.9rem;">DONE</button>
            </div>
        </div>
        <div class="sheet-body">
            <div class="filter-options">
                <div class="filter-option selected" onclick="applyFilterOption('ALL', this)">
                    <span>ALL EVENTS</span>
                    <svg class="icon-sm check-icon" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>
                </div>
                <div class="filter-option" onclick="applyFilterOption('PARTY', this)">
                    <span>PARTY</span>
                    <svg class="icon-sm check-icon" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>
                </div>
                <div class="filter-option" onclick="applyFilterOption('RACE', this)">
                    <span>RACE</span>
                    <svg class="icon-sm check-icon" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>
                </div>
                <div class="filter-option" onclick="applyFilterOption('SHOW', this)">
                    <span>SHOW</span>
                    <svg class="icon-sm check-icon" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>
                </div>
                <div class="filter-option" onclick="applyFilterOption('MEET', this)">
                    <span>MEET</span>
                    <svg class="icon-sm check-icon" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>
                </div>
            </div>
        </div>
    </div>
  </div>

  <div id="scannerModal" class="overlay">
      <div style="width:100%; max-width:400px; padding:20px; position:relative; display:flex; flex-direction:column; align-items:center;">
          <button class="btn-icon-back" onclick="stopScanner()">
            <svg viewBox="0 0 24 24"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
          </button>
          <div id="reader"></div>
          <button onclick="stopScanner()" style="margin-top:20px; width:100%; height:50px; background:white; color:black; border:none; border-radius:12px; font-weight:700;">CANCEL SCAN</button>
      </div>
  </div>

  <div id="scanResultModal" class="overlay">
      <div class="scan-card">
          <div id="scanIcon" class="scan-icon-circle"></div>
          <div id="scanStatus" class="scan-status"></div>
          <div id="scanName" class="scan-name"></div>
          <button onclick="document.getElementById('scanResultModal').classList.remove('visible'); startScanner();" style="margin-top:24px; width:100%; height:50px; background:var(--bg-body); color:var(--text-main); border:none; border-radius:12px; font-weight:700;">SCAN NEXT</button>
          <button onclick="document.getElementById('scanResultModal').classList.remove('visible')" style="margin-top:12px; width:100%; height:50px; background:transparent; color:var(--text-muted); border:none; font-weight:600;">DONE</button>
      </div>
  </div>

  <div id="qrDisplayModal" class="overlay qr-overlay">
      <div class="qr-pass-card">
          <div class="qr-pass-header">
              <div id="qrPassTitle" class="qr-pass-title">EVENT TITLE</div>
              <div id="qrPassMeta" class="qr-pass-meta">DATE ‚Ä¢ TIME</div>
          </div>
          <div class="qr-code-wrapper">
              <div id="qrModalTarget"></div>
          </div>
          <div class="qr-pass-footer">
              <div class="qr-user-name" id="qrPassUser">USER NAME</div>
              <div class="qr-admit-label">ADMIT ONE</div>
          </div>
      </div>
      <button onclick="document.getElementById('qrDisplayModal').classList.remove('visible')" class="btn-close-qr">CLOSE PASS</button>
  </div>

  <div id="toast" class="toast">
      <div class="toast-icon"></div>
      <span id="toastMsg" style="font-weight:600; font-size:0.95rem;">Notification</span>
  </div>

  <script>
    /* =========================================
       PROJECT FIDA: MERGED LOGIC (Frontend + API)
       ========================================= */

    // --- GLOBAL STATE ---
    let currentUser = null;
    let currentEvents = []; 
    let joinedEventIds = [];
    let html5QrcodeScanner = null;
    let currentSearch = '';
    let currentFilter = 'ALL';
    
    // Carousel Vars
    let currentSlide = 0;
    let carouselInterval;
    
    // Onboarding Vars
    let obStep = 0;

    // --- INITIALIZATION ---

    window.addEventListener('load', () => {
        // Splash Screen
        setTimeout(() => {
            const splash = document.getElementById('splashScreen');
            if(splash) {
                splash.style.opacity = '0';
                setTimeout(() => splash.classList.add('hidden'), 600);
            }
        }, 1200);

        initCreateHandle();
        startCarousel();

        // Overlay Click Handlers
        document.querySelectorAll('.overlay').forEach(o => {
            o.addEventListener('click', e => { if (e.target === o) o.classList.remove('visible'); });
        });

        // Google Auth Init
        if(window.google) {
            google.accounts.id.initialize({
                client_id: "611302719944-4fn2hr7i1l9tn2chvu9719pngbcpgrau.apps.googleusercontent.com", 
                callback: handleGoogleResponse
            });
            const btnContainer = document.getElementById("googleBtnContainer");
            if(btnContainer) {
                google.accounts.id.renderButton(
                    btnContainer,
                    { theme: "outline", size: "large", width: "100%", shape: "pill" }
                );
            }
        }
        
        checkAuth();
    });

    // --- AUTHENTICATION FLOW ---

    async function handleGoogleResponse(response) {
        try {
            const data = await FidaAPI.auth.googleLogin(response.credential);
            
            if(data.success) {
                localStorage.setItem('fida_token', data.token);
                showToast(`Welcome, ${data.user.name}`);
                checkAuth();
            } else {
                showToast('Login Failed');
            }
        } catch(e) {
            console.error(e);
            showToast('Connection Error');
        }
    }

    async function checkAuth() {
        const token = localStorage.getItem('fida_token');
        
        if (!token) {
            showAuthScreen();
            return;
        }

        try {
            const user = await FidaAPI.auth.getMe();
            currentUser = user;
            joinedEventIds = currentUser.joinedEvents || []; 
                
            hideAuthScreen();
            updateUserUI();
            fetchAndRenderFeed();
            
            // Logic to show onboarding if user has no events (assumption: new user)
            if(joinedEventIds.length === 0) {
                 setTimeout(() => showOnboarding(), 500);
            }

            switchView('home', document.querySelector('.dock-item:first-child'));

        } catch (e) {
            console.error("Auth check failed", e);
            if(e.message === 'Session invalid') logout();
            else showAuthScreen();
        }
    }

    function showAuthScreen() { document.getElementById('authScreen').classList.remove('hide'); }
    function hideAuthScreen() { document.getElementById('authScreen').classList.add('hide'); }

    function logout() {
        localStorage.removeItem('fida_token');
        currentUser = null;
        joinedEventIds = [];
        showAuthScreen();
        location.reload(); 
    }



    //IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII experimental stages for now
    async function loadProfileData() {
        try {
            // Using the requested API method
            const details = await FidaAPI.profile.loadDetails();
            
            if(details) {
                document.getElementById('pName').value = details.name || currentUser.name || '';
                document.getElementById('pEmail').value = details.email || currentUser.email || '';
                document.getElementById('pPhone').value = details.phone || '';
                document.getElementById('pCity').value = details.city || '';
            }
        } catch (e) {
            console.error("Error loading profile details", e);
            // Fallback to basic auth data if API fails
            document.getElementById('pName').value = currentUser.name || '';
            document.getElementById('pEmail').value = currentUser.email || '';
        }
    }
    async function saveProfile(e) {
        e.preventDefault();
        const btn = e.target.querySelector('button');
        const originalText = btn.innerText;
        btn.innerText = 'SAVING...';
        btn.disabled = true;

        const updatedData = {
            name: document.getElementById('pName').value,
            phone: document.getElementById('pPhone').value,
            city: document.getElementById('pCity').value
        };

        try {
            // Assuming an update method exists alongside loadDetails
            const result = await FidaAPI.profile.update(updatedData);//IIIIIIIIIIIII
            if(result.success) {
                showToast('Profile Updated');
                if(updatedData.name) {
                    currentUser.name = updatedData.name;
                    document.getElementById('headerName').innerText = updatedData.name.split(' ')[0].toUpperCase();
                }
            } else {
                showToast('Update Failed');
            }
        } catch(err) {
            console.error(err);
            showToast('Network Error');
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }
    function handleAvatarUpload(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const imgTag = `<img src="${e.target.result}">`;
                document.getElementById('settingsAvatarDisplay').innerHTML = imgTag;
                document.getElementById('headerAvatar').innerHTML = imgTag;
                showToast('Photo Updated');
                // Logic to push to API would go here
            }
            reader.readAsDataURL(input.files[0]);
        }
    }//fuck this

    function updateUserUI() {
        if (!currentUser) return;
        
        // Header Updates
        document.getElementById('headerName').innerText = currentUser.name.split(' ')[0].toUpperCase();
        const avatarImg = currentUser.picture ? `<img src="${currentUser.picture}">` : currentUser.name.charAt(0);
        document.getElementById('headerAvatar').innerHTML = avatarImg;
        
        // Settings/Profile Page Updates
        document.getElementById('settingsAvatarDisplay').innerHTML = avatarImg;
        
        // Load detailed form data
        loadProfileData();
    }
    const staticContentData = {
        about: `
            <h2 style="font-size:1.5rem; margin-bottom:16px; color:var(--text-main);">About GigByCity</h2>
            <p>GigByCity is the premier underground event discovery protocol. We connect the city's most exclusive hosts with the people who make the night come alive.</p>
            <br>
            <h3 style="font-size:1.1rem; color:var(--text-main);">Version 2.8.0</h3>
            <p>Well, this is the official designed app, designed for convenience, accessibility and privacy.</p>
        `,
        privacy: `
            <h2 style="font-size:1.5rem; margin-bottom:16px; color:var(--text-main);">Privacy & Security</h2>
            <p><strong>1. Data Collection</strong><br>We collect minimal data required to verify your identity and issue secure passes. Your location data is used solely to find events in your sector.</p>
            <br>
            <p><strong>2. Event Safety</strong><br>Hosts are verified through our protocol. However, attend events at your own risk. GigByCity is not liable for off-grid activities.</p>
            <br>
            <p><strong>3. QR Security</strong><br>Your pass is cryptographically signed. Do not share your QR code; it is your unique identity token for the night.</p>
        `
    };

    function openInfoSheet(type) {
        const content = document.getElementById('infoContent');
        const modal = document.getElementById('infoModal');
        
        if(staticContentData[type]) {
            content.innerHTML = staticContentData[type];
            modal.classList.add('visible');
        }
    }
    //IIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIIII

    // --- ONBOARDING LOGIC ---
    function showOnboarding() {
        document.getElementById('onboardingModal').classList.add('visible');
        renderObSlide(0);
    }

    function renderObSlide(index) {
        obStep = index;
        document.querySelectorAll('.onboarding-slide').forEach((s, i) => {
            s.classList.toggle('active', i === index);
        });
        document.querySelectorAll('.ob-dot').forEach((d, i) => {
            d.classList.toggle('active', i === index);
        });
        
        const btn = document.querySelector('#onboardingModal .btn-main');
        if(index === 2) {
            btn.textContent = "GET STARTED";
        } else {
            btn.textContent = "NEXT";
        }
    }

    function nextOnboarding() {
        if(obStep < 2) {
            renderObSlide(obStep + 1);
        } else {
            closeOnboarding();
        }
    }

    function closeOnboarding() {
        document.getElementById('onboardingModal').classList.remove('visible');
    }

    // --- DATA & RENDERING ---

    async function fetchAndRenderFeed() {
        try {
            const data = await FidaAPI.events.getAll();
            currentEvents = data;
            renderFeed();
            renderPasses();
            renderHostDashboard();
        } catch (e) {
            console.error("Failed to fetch events", e);
            showToast("Could not load feed");
        }
    }

    function renderFeed() {
        const container = document.getElementById('clubsContainer'); 
        container.innerHTML = '';
        
        // Filter: Search AND Category
        let filtered = currentEvents.filter(item => 
            (item.title.toLowerCase().includes(currentSearch) || 
            (item.location && item.location.toLowerCase().includes(currentSearch)))
        );
        
        if (currentFilter !== 'ALL') {
            filtered = filtered.filter(item => item.category === currentFilter);
        }

        if(filtered.length === 0) {
            container.innerHTML = `<div class="empty-state">NO SIGNALS FOUND</div>`;
            return;
        }

        filtered.forEach(event => {
            const id = event._id || event.id;
            const isJoined = joinedEventIds.includes(id);
            const isHost = (currentUser && event.creatorId === currentUser._id);
            const attendeesCount = event.attendees ? event.attendees.length : 0;
            const maxAttendees = event.maxAttendees || Infinity;
            const isSoldOut = attendeesCount >= maxAttendees;
            const isOnline = event.mode === 'online';
            const locIcon = isOnline ? 'üåê' : 'üìç';
            const priceDisplay = (!event.price || event.price === 0) ? 'FREE' : `$${event.price}`;
            
            let badgeHtml = '';
            if (isSoldOut && !isJoined && !isHost) {
                badgeHtml = '<div style="background:var(--text-main); color:var(--bg-body); font-size:0.7rem; font-weight:800; padding:4px 8px; border-radius:4px; position:absolute; top:20px; right:20px;">SOLD OUT</div>';
            }

            // Determine Button State
            let btnLabel = isJoined ? 'GOT PASS' : (isSoldOut ? 'FULL' : 'GET PASS');
            let btnAction = `event.stopPropagation(); ${isJoined ? `openDetail('${id}')` : `joinClub('${id}')`}`;
            let btnClass = isSoldOut && !isJoined ? 'sold-out' : '';

            if (isHost) {
                btnLabel = 'MANAGE DROP';
                btnAction = `event.stopPropagation(); switchView('host', document.querySelectorAll('.dock-item')[3]); openHostDetail('${id}')`;
                btnClass = 'host-btn';
            }

            const html = `
                <div class="ticket ${isJoined ? 'joined' : ''}" onclick="openDetail('${id}')">
                    <div class="ticket-inner">
                        <div class="ticket-status-bar"></div>
                        ${badgeHtml}
                        <div class="ticket-bg-num">0${id.toString().substring(id.toString().length-2)}</div>
                        <div class="ticket-content">
                            <div class="t-header">
                                <div class="t-title">${event.title}</div>
                                <div style="display:flex; gap:6px;">
                                    <div class="t-loc">${locIcon} ${event.location || 'TBA'}</div>
                                    <div class="t-loc" style="background:var(--border);">${event.category || 'EVENT'}</div>
                                </div>
                            </div>
                            <div class="t-desc">${event.description || ''}</div>
                            <div class="t-info-grid">
                                <div class="t-cell"><label>Date</label><div>${formatDate(event.date)}</div></div>
                                <div class="t-cell"><label>Time</label><div>${event.time}</div></div>
                                <div class="t-cell t-price"><div>${priceDisplay}</div></div>
                            </div>
                        </div>
                        <div class="ticket-rip"><div class="rip-line"></div></div>
                        <div class="ticket-stub">
                            <div class="stub-code">129394</div>
                            <button ${isSoldOut && !isJoined && !isHost ? 'disabled' : ''} class="btn-action ${btnClass}" onclick="${btnAction}">
                                 ${btnLabel}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        });
    }

    function renderPasses() {
        const container = document.getElementById('passesContainer'); 
        container.innerHTML = '';
        
        const myEvents = currentEvents.filter(e => joinedEventIds.includes(e._id || e.id));
        
        if(myEvents.length === 0) {
            container.innerHTML = '<div class="empty-state">No active passes.<br>Find an event in the feed.</div>';
            return;
        }

        myEvents.forEach(event => {
            const id = event._id || event.id;
            const isOnline = event.mode === 'online';
            const locIcon = isOnline ? 'üåê' : 'üìç';
            
            // Check if user is checked in
            // Note: The attendee object structure depends on API response.
            // Assuming event.attendees is array of IDs or Objects.
            // Simplified check logic:
            const isCheckedIn = false; // Placeholder as API doesn't return detailed attendee status in 'getAll' usually

            const html = `
                <div class="pass-card ${isCheckedIn ? 'checked-in' : ''}" onclick="openDetail('${id}')">
                    <div class="pass-top-row">
                        <div class="pass-date">${formatDate(event.date)} ‚Ä¢ ${event.time}</div>
                        <div class="pass-status-pill">${isCheckedIn ? 'CHECKED IN' : 'ACTIVE'}</div>
                    </div>
                    <div>
                        <div class="pass-title">${event.title}</div>
                        <div class="pass-loc">${locIcon} ${event.location}</div>
                    </div>
                    <div class="pass-actions">
                        <button class="btn-pass-action" onclick="event.stopPropagation(); showUserQR('${id}', '${event.title.replace(/'/g, "\\'")}')">
                            <svg class="icon-sm" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                            ${isCheckedIn ? 'SHOW ENTRY PASS' : 'SCAN ENTRY'}
                        </button>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        });
    }

    function renderHostDashboard() {
        const container = document.getElementById('hostContainer'); 
        container.innerHTML = '';
        
        if(!currentUser) return;
        const hostedEvents = currentEvents.filter(x => x.creatorId === currentUser._id);

        if(hostedEvents.length === 0) {
            container.innerHTML = '<div class="empty-state">You haven\'t dropped any events.<br>Tap + to create.</div>';
            return;
        }

        hostedEvents.forEach(event => {
            const count = event.attendees ? event.attendees.length : 0;
            const html = `
                <div class="ticket" onclick="openHostDetail('${event._id}')">
                    <div class="ticket-inner">
                         <div class="ticket-content">
                            <div class="t-header">
                                <div class="t-title">${event.title}</div>
                                <div class="t-loc">Guest List: ${count}</div>
                            </div>
                            <div class="t-desc">Tap to manage access & verify tickets.</div>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        });
    }

    // --- CAROUSEL LOGIC ---
    function startCarousel() {
        const track = document.getElementById('heroTrack');
        const slides = document.querySelectorAll('.hero-slide');
        if(!track || slides.length === 0) return;

        // Auto Scroll
        carouselInterval = setInterval(() => {
            currentSlide = (currentSlide + 1) % slides.length;
            scrollToSlide(currentSlide);
        }, 4000);

        // Observer for manual swipes
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if(entry.isIntersecting) {
                    const index = Array.from(slides).indexOf(entry.target);
                    currentSlide = index;
                    slides.forEach(s => s.classList.remove('in-view'));
                    if(slides[index]) slides[index].classList.add('in-view');
                    updateDots(currentSlide);
                }
            });
        }, { threshold: 0.6 });

        slides.forEach(slide => observer.observe(slide));
        if(slides[0]) slides[0].classList.add('in-view');
        
        // Pause on touch
        track.addEventListener('touchstart', () => clearInterval(carouselInterval));
        track.addEventListener('touchend', () => {
             clearInterval(carouselInterval);
             carouselInterval = setInterval(() => {
                currentSlide = (currentSlide + 1) % slides.length;
                scrollToSlide(currentSlide);
             }, 4000);
        });
    }

    function scrollToSlide(index) {
        const track = document.getElementById('heroTrack');
        const slides = document.querySelectorAll('.hero-slide');
        if (track && slides[index]) {
            const slideWidth = slides[index].offsetWidth;
            track.scrollTo({ left: slideWidth * index, behavior: 'smooth' });
            updateDots(index);
        }
    }

    function updateDots(index) {
        document.querySelectorAll('.dot').forEach((d, i) => {
            d.classList.toggle('active', i === index);
        });
    }

    // --- FILTER LOGIC ---
    function openFilterModal() { document.getElementById('filterModal').classList.add('visible'); }
    function closeFilterModal() { document.getElementById('filterModal').classList.remove('visible'); }

    function applyFilterOption(filterType, el) {
        currentFilter = filterType;
        document.querySelectorAll('.filter-option').forEach(o => o.classList.remove('selected'));
        el.classList.add('selected');
        renderFeed();
        closeFilterModal();
    }


    // --- ACTIONS & MODALS ---

    async function handleCreate(e) {
        e.preventDefault();

        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<div class="spinner"></div> Publishing...';
        submitBtn.disabled = true;
        
        const formData = new FormData();
        formData.append('title', document.getElementById('cName').value);
        formData.append('description', document.getElementById('cDesc').value);
        formData.append('date', document.getElementById('cDate').value);
        formData.append('time', document.getElementById('cTime').value);
        formData.append('location', document.getElementById('cLoc').value);
        formData.append('price', document.getElementById('cPrice').value || 0);
        formData.append('mode', document.getElementById('cMode').value || 'offline');
        formData.append('maxAttendees', document.getElementById('cMax').value || Infinity);
        formData.append('category', document.getElementById('cCategory').value || 'PARTY');
        
        const imageFile = document.getElementById('cImageInput')?.files[0];
        if (imageFile) formData.append('image', imageFile);

        showToast('Uploading your drop...', 'info');
        
        try {
            const data = await FidaAPI.events.create(formData);
            
            if(data.success) {
                showToast('Drop Published');
                closeCreateModal();
                e.target.reset();
                document.getElementById('cImagePreview').style.display = 'none';
                fetchAndRenderFeed();
                switchView('host', document.querySelectorAll('.dock-item')[3]);
            } else {
                showToast(data.error || 'Creation Failed');
            }
        } catch(err) {
            console.error(err);
            showToast('Network Error');
        } finally {
            submitBtn.innerHTML = originalBtnText;
            submitBtn.disabled = false;
        }
    }

    async function joinClub(id) {
        try {
            const data = await FidaAPI.events.join(id);
            
            if(data.success) {
                joinedEventIds.push(id);
                showToast('Pass Granted');
                fetchAndRenderFeed();
                
                if(document.getElementById('detailsModal').classList.contains('visible')) {
                    openDetail(id);
                }
            } else {
                showToast(data.error || 'Join Failed');
            }
        } catch(err) {
            showToast('Network Error');
        }
    }

    function openDetail(id) {
        const event = currentEvents.find(e => (e._id || e.id) === id);
        if(!event) return;
        
        const isJoined = joinedEventIds.includes(id);
        const modal = document.getElementById('detailsModal');
        const content = document.getElementById('detailsContent');
        
        const count = event.attendees ? event.attendees.length : 0;
        const max = event.maxAttendees || Infinity;
        const isSoldOut = count >= max;
        const priceDisplay = (!event.price) ? 'FREE' : `$${event.price}`;
        const hostName = (!event.creatorName) ? 'Unknown' : event.creatorName;

        content.innerHTML = `
            <img src="${event.image || ''}" class="detail-cover" style="${!event.image ? 'display:none' : ''}">
            <h2 style="font-size:2rem; font-weight:800; line-height:1; margin-bottom:8px;">${event.title}</h2>
            <div style="display:flex; gap:12px; margin-bottom:24px;">
                <span class="t-loc">${event.location}</span>
                <span class="t-loc">${formatDate(event.date)} @ ${event.time}</span>
                <span class="t-loc">@ ${hostName}</span>
            </div>
            
            <div style="background:var(--bg-card-sub); padding:16px; border-radius:16px; margin-bottom:24px; display:flex; justify-content:space-between; align-items:center;">
                <span style="font-weight:700; color:var(--text-sec); font-size:0.9rem;">Spots Left</span>
                <span style="font-weight:700; font-family:var(--font-mono);">${max === Infinity ? 'Unlimited' : (max - count) + ' / ' + max}</span>
            </div>

            <p style="color:var(--text-sec); line-height:1.6; margin-bottom:32px;">${event.description || 'No description.'}</p>
            <button class="btn-main ${isSoldOut && !isJoined ? 'sold-out' : ''}" onclick="${isJoined ? '' : `joinClub('${id}')`}">
                ${isJoined ? 'ALREADY JOINED' : (isSoldOut ? 'SOLD OUT' : `GET PASS ‚Ä¢ ${priceDisplay}`)}
            </button>
        `;
        
        modal.classList.add('visible');
    }

    function openHostDetail(id) {
        const event = currentEvents.find(e => (e._id || e.id) === id);
        if(!event) return;
        
        const content = document.getElementById('hostDetailContent');
        const count = event.attendees ? event.attendees.length : 0;
        
        content.innerHTML = `
            <div style="margin-bottom:20px; text-align:center;">
                <h2 style="font-size:1.8rem; font-weight:800; margin-bottom:4px;">${event.title}</h2>
                <div style="font-size:0.8rem; color:var(--text-muted); font-weight:600;">TAP STATUS TO VERIFY MANUALLY</div>
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:24px;">
                <div style="background:var(--bg-card-sub); padding:16px; border-radius:16px; text-align:center;">
                    <div style="font-size:1.5rem; font-weight:700;">${count}</div>
                    <div style="font-size:0.7rem; color:var(--text-muted); font-weight:600;">SOLD</div>
                </div>
                <div style="background:var(--bg-card-sub); padding:16px; border-radius:16px; text-align:center;">
                    <div style="font-size:1.5rem; font-weight:700; color:var(--success);">--</div>
                    <div style="font-size:0.7rem; color:var(--text-muted); font-weight:600;">CHECKED IN</div>
                </div>
            </div>
            <div class="empty-state" style="padding:20px 0;">Use the Scanner button on the Host Dashboard to check people in.</div>
        `;
        
        document.getElementById('hostDetailModal').classList.add('visible');
    }

    function showUserQR(eventId, eventTitle) {
        const modal = document.getElementById('qrDisplayModal');
        const target = document.getElementById('qrModalTarget');
        const title = document.getElementById('qrPassTitle');
        const meta = document.getElementById('qrPassMeta');
        const userLabel = document.getElementById('qrPassUser');
        
        const event = currentEvents.find(e => (e._id || e.id) === eventId);

        target.innerHTML = ''; 
        title.textContent = eventTitle;
        if(event) {
            meta.textContent = `${formatDate(event.date)} ‚Ä¢ ${event.time}`;
        }
        userLabel.textContent = currentUser ? currentUser.name.toUpperCase() : 'USER';
        
        const payload = `${eventId}-${currentUser._id}`;
        
        new QRCode(target, {
            text: payload,
            width: 180,
            height: 180,
            colorDark : "#000000",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.H
        });
        
        modal.classList.add('visible');
    }

    // --- SCANNER LOGIC ---

    function startScanner() {
        document.getElementById('scannerModal').classList.add('visible');
        if(!html5QrcodeScanner) {
            html5QrcodeScanner = new Html5Qrcode("reader");
        }
        
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        html5QrcodeScanner.start(
            { facingMode: "environment" }, 
            config, 
            onScanSuccess
        ).catch(err => {
            console.error("Scanner Error", err);
            showToast("Camera Access Denied");
        });
    }

    function stopScanner() {
        document.getElementById('scannerModal').classList.remove('visible');
        if(html5QrcodeScanner) {
            html5QrcodeScanner.stop().then(() => html5QrcodeScanner.clear()).catch(console.log);
        }
    }

    function onScanSuccess(decodedText, decodedResult) {
        if(html5QrcodeScanner) html5QrcodeScanner.pause();
        document.getElementById('scannerModal').classList.remove('visible');
        
        const splitIndex = decodedText.indexOf('-');
        if(splitIndex === -1) {
            showScanResult('error', 'Invalid Format', 'Unknown');
            return;
        }
        
        const eventId = decodedText.substring(0, splitIndex);
        const userId = decodedText.substring(splitIndex + 1);
        
        const event = currentEvents.find(e => (e._id || e.id) === eventId);
        
        if(!event) {
            showScanResult('error', 'Event Not Found', userId);
            return;
        }
        
        if(event.creatorId !== currentUser._id) {
            showScanResult('error', 'Wrong Host', 'This is not your event');
            return;
        }
        
        // Success scenario
        showScanResult('success', 'ACCESS GRANTED', userId);
    }

    function showScanResult(type, title, sub) {
        const modal = document.getElementById('scanResultModal');
        const icon = document.getElementById('scanIcon');
        const status = document.getElementById('scanStatus');
        const name = document.getElementById('scanName');
        
        modal.classList.add('visible');
        status.textContent = title;
        name.textContent = sub;
        
        if(type === 'success') {
            icon.style.color = 'var(--success)';
            icon.style.border = '2px solid var(--success)';
            icon.innerHTML = '‚úì';
            status.style.color = 'var(--success)';
        } else {
            icon.style.color = 'var(--accent)';
            icon.style.border = '2px solid var(--accent)';
            icon.innerHTML = '‚úï';
            status.style.color = 'var(--accent)';
        }
    }

    // --- UTILITIES ---

    function switchView(viewName, el) {
        document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
        const targetId = viewName === 'home' ? 'viewHome' : 
                         viewName === 'passes' ? 'viewPasses' :
                         viewName === 'host' ? 'viewHost' : 'viewSettings';
        document.getElementById(targetId).classList.add('active');
        
        document.querySelectorAll('.dock-item').forEach(i => i.classList.remove('active'));
        if(el) el.classList.add('active');
        window.scrollTo(0,0);
    }

    function handleSearch(val) {
        currentSearch = val.toLowerCase();
        renderFeed();
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        if (!t) return;
        document.getElementById('toastMsg').textContent = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }

    function formatDate(dateStr) {
        if(!dateStr) return '';
        return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function setEventMode(mode) {
        document.getElementById('cMode').value = mode;
        const btnOffline = document.getElementById('btnOffline');
        const btnOnline = document.getElementById('btnOnline');
        const locInput = document.getElementById('cLoc');
        const iconContainer = document.getElementById('cLocIcon');
        
        if (mode === 'online') {
            btnOnline.classList.add('active');
            btnOffline.classList.remove('active');
            locInput.placeholder = "Server URL / Link";
            iconContainer.innerHTML = '<svg class="icon-sm" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>';
        } else {
            btnOffline.classList.add('active');
            btnOnline.classList.remove('active');
            locInput.placeholder = "Location";
            iconContainer.innerHTML = '<svg class="icon-sm" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>';
        }
    }

    // Image Preview Listener
    function previewImage(input) {
        if (input.files && input.files[0]) {
            const preview = document.getElementById('cImagePreview');
            const reader = new FileReader();
            reader.onload = function(event) {
                preview.src = event.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function selectCategory(el, val) {
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('cCategory').value = val;
    }

    function openCreateModal() { document.getElementById('createModal').classList.add('visible'); }
    function closeCreateModal() { document.getElementById('createModal').classList.remove('visible'); }

    function initCreateHandle() {
        const handle = document.getElementById('createHandle');
        if(!handle) return;
        
        let startY;
        handle.addEventListener('touchstart', e => startY = e.touches[0].clientY, {passive:true});
        handle.addEventListener('touchend', e => {
            if(startY - e.changedTouches[0].clientY < -50) closeCreateModal();
        }, {passive:true});
    }
  </script>
</body>
</html>